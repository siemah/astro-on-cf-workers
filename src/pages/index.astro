---
import { handleAllSettledResults } from "@/lib/utils";
import type { ShippingData } from "@/lib/types";
import { getCollection } from "astro:content";
import { getEntry } from "astro:content";
import HomePage from "@/components/pages/home";
import Layout from "@/components/layout.astro";

const response = await Promise.allSettled([
  getCollection("products"),
  getCollection("shippings"),
]);
const [productsList, shippingsArray] =
  handleAllSettledResults(response);
const shippings = shippingsArray?.reduce(
  (acc, shipping) => {
    acc[shipping.data.id] = shipping.data.data;
    return acc;
  },
  {} as Record<string, ShippingData>,
);
let products = productsList.map((product: any) => {
  return product.data;
});
---

<Layout
  title={`Astro on Cloudflare Workers`}
  description="Astro on Cloudflare Workers"
  image={products?.[0]?.images?.[0].url ?? ""}
>
  <HomePage
    products={products}
    shippings={shippings}
    apiEndpoint={import.meta.env.WORKER_API_URL}
    client:idle
  />
</Layout>
